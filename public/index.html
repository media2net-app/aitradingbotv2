<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Command center â€“ api.aitrading.software</title>
  <style>
    :root { --bg: #0f0f12; --card: #1a1a20; --text: #e4e4e7; --muted: #71717a; --green: #22c55e; --yellow: #eab308; --red: #ef4444; --blue: #3b82f6; }
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 1rem; min-height: 100vh; max-width: 1200px; margin-left: auto; margin-right: auto; }
    h1 { font-size: 1.35rem; font-weight: 600; margin: 0 0 0.25rem 0; }
    h2 { font-size: 1rem; font-weight: 600; margin: 1.25rem 0 0.5rem 0; color: var(--muted); }
    .sub { color: var(--muted); font-size: 0.875rem; margin-bottom: 1rem; }
    a { color: var(--blue); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .cmd-row { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .toggle-wrap { display: flex; align-items: center; gap: 0.75rem; background: var(--card); padding: 0.75rem 1rem; border-radius: 8px; border: 1px solid #2a2a30; }
    .toggle-label { font-weight: 600; font-size: 1rem; }
    .toggle-btn { width: 52px; height: 28px; border-radius: 14px; border: none; cursor: pointer; position: relative; transition: background 0.2s; }
    .toggle-btn.on { background: var(--green); }
    .toggle-btn.off { background: var(--muted); }
    .toggle-btn::after { content: ''; position: absolute; width: 22px; height: 22px; border-radius: 50%; background: #fff; top: 3px; transition: left 0.2s; }
    .toggle-btn.on::after { left: 27px; }
    .toggle-btn.off::after { left: 3px; }
    .toggle-status { font-size: 0.875rem; color: var(--muted); }
    .toggle-status.on { color: var(--green); }
    .toggle-status.off { color: var(--red); }

    .connections { display: grid; gap: 1rem; }
    .conn-card { background: var(--card); border-radius: 8px; border: 1px solid #2a2a30; overflow: hidden; }
    .conn-head { padding: 0.75rem 1rem; border-bottom: 1px solid #2a2a30; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
    .conn-name { font-weight: 600; }
    .conn-meta { font-size: 0.8125rem; color: var(--muted); }
    .conn-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.75rem; padding: 1rem; }
    .conn-kv { font-size: 0.8125rem; }
    .conn-kv .k { color: var(--muted); }
    .conn-kv .v { font-weight: 500; }
    .conn-kv .v.profit { color: var(--green); }
    .conn-kv .v.loss { color: var(--red); }
    .conn-trades { padding: 0 1rem 1rem; }
    .conn-trades table { width: 100%; font-size: 0.75rem; border-collapse: collapse; }
    .conn-trades th, .conn-trades td { text-align: left; padding: 0.35rem 0.5rem; border-bottom: 1px solid #2a2a30; }
    .conn-trades th { color: var(--muted); font-weight: 500; }
    .no-conn { color: var(--muted); padding: 1rem; text-align: center; background: var(--card); border-radius: 8px; border: 1px solid #2a2a30; }

    .debug-box { background: var(--card); border-radius: 8px; border: 1px solid #2a2a30; padding: 1rem; margin-top: 0.75rem; }
    .debug-box h3 { font-size: 0.875rem; margin: 0 0 0.5rem 0; color: var(--yellow); }
    .debug-list { font-size: 0.8125rem; line-height: 1.6; color: var(--muted); margin: 0; padding-left: 1.25rem; }
    .debug-list li { margin-bottom: 0.25rem; }
    .debug-list .ok { color: var(--green); }
    .debug-list .fail { color: var(--red); }
    .debug-list .action { color: var(--text); }
    .debug-test { margin-top: 0.75rem; }
    .debug-test button { background: #25252b; color: var(--text); border: 1px solid #3a3a42; border-radius: 4px; padding: 0.35rem 0.75rem; cursor: pointer; font-size: 0.8125rem; }
    .debug-test button:hover { background: #2a2a30; }
    .debug-result { margin-top: 0.5rem; font-size: 0.8125rem; }
    .debug-result.ok { color: var(--green); }
    .debug-result.err { color: var(--red); }
    .muted { color: var(--muted); }
    code { background: #25252b; padding: 0.1rem 0.35rem; border-radius: 3px; font-size: 0.8em; }

    .status { display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
    .status .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; }
    .status.empty .dot { background: var(--muted); }
    @keyframes pulse { 50% { opacity: 0.6; } }
    .log-box { background: var(--card); border-radius: 8px; border: 1px solid #2a2a30; overflow: hidden; margin-top: 1rem; }
    .log-toolbar { padding: 0.5rem 0.75rem; border-bottom: 1px solid #2a2a30; display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
    .log-toolbar label { font-size: 0.8125rem; color: var(--muted); }
    .log-toolbar select { background: #25252b; color: var(--text); border: 1px solid #3a3a42; border-radius: 4px; padding: 0.25rem 0.5rem; }
    #logList { padding: 0.5rem; max-height: 50vh; overflow-y: auto; font-size: 0.8125rem; font-family: ui-monospace, monospace; line-height: 1.5; }
    .log-line { padding: 0.25rem 0.5rem; border-radius: 4px; margin-bottom: 2px; word-break: break-word; }
    .log-line .ts { color: var(--muted); margin-right: 0.5rem; }
    .log-line.level-info { color: var(--text); }
    .log-line.level-warn { background: rgba(234,179,8,0.1); color: var(--yellow); }
    .log-line.level-error { background: rgba(239,68,68,0.1); color: var(--red); }
    .log-line.vps { background: rgba(34,197,94,0.08); color: var(--green); }
    .log-line.signal { background: rgba(59,130,246,0.08); }
    .log-line.trade { background: rgba(34,197,94,0.12); color: var(--green); }
    .empty { color: var(--muted); padding: 1rem; text-align: center; }
  </style>
</head>
<body>
  <h1>Command center</h1>
  <p class="sub">api.aitrading.software Â· <a href="/settings">Instellingen</a></p>

  <div class="cmd-row">
    <div class="toggle-wrap">
      <button type="button" class="toggle-btn" id="tradingToggle" title="AI trading aan/uit"></button>
      <div>
        <div class="toggle-label">AI trading</div>
        <div class="toggle-status" id="tradingStatus">Ladenâ€¦</div>
      </div>
    </div>
  </div>

  <h2>Verbonden VPS / accounts</h2>
  <div id="connectionsContainer" class="connections">
    <div class="no-conn">Geen verbindingen. Zet in de EA <strong>UseWebHeartbeat = true</strong> en zorg dat de EA draait.</div>
  </div>

  <div class="debug-box" id="debugBox">
    <h3>ðŸ”§ Debug â€“ verbinding controleren</h3>
    <ul class="debug-list" id="debugList">
      <li class="action">1. In MT5: EA op chart â†’ rechtermuisklik â†’ Expert Advisors â†’ <strong>Properties</strong></li>
      <li class="action">2. Zet <strong>UseWebHeartbeat = true</strong> en <strong>UseWebLog = true</strong></li>
      <li class="action">3. MT5: <strong>Tools â†’ Options â†’ Expert Advisors</strong> â†’ vink "Allow WebRequest for listed URL" aan en voeg toe: <code>https://api.aitrading.software</code></li>
      <li class="action">4. EA opnieuw starten (chart herladen of EA opnieuw aan chart koppelen)</li>
      <li id="debugApiStatus">5. API-bereikbaarheid: <span class="muted">Klik op "Test API"</span></li>
    </ul>
    <div class="debug-test">
      <button type="button" id="debugTestBtn">Test API</button>
      <div class="debug-result" id="debugResult"></div>
    </div>
  </div>

  <h2>Live log</h2>
  <div class="status" id="status"><span class="dot" id="dot"></span><span id="statusText">Ladenâ€¦</span></div>
  <div class="sub" id="eaStatus" style="margin-top:0.25rem;"></div>
  <div class="log-box">
    <div class="log-toolbar">
      <label>Refresh</label>
      <select id="interval">
        <option value="3">3 sec</option>
        <option value="5">5 sec</option>
        <option value="10">10 sec</option>
      </select>
      <label>Niveau</label>
      <select id="level">
        <option value="all">Alles</option>
        <option value="info">Info</option>
        <option value="warn">Warn</option>
        <option value="error">Error</option>
      </select>
    </div>
    <div id="logList" class="empty">Geen logs.</div>
  </div>

  <script>
    const logList = document.getElementById('logList');
    const statusEl = document.getElementById('status');
    const statusText = document.getElementById('statusText');
    const tradingToggle = document.getElementById('tradingToggle');
    const tradingStatus = document.getElementById('tradingStatus');
    const connectionsContainer = document.getElementById('connectionsContainer');
    let intervalMs = 3000;
    let levelFilter = 'all';
    let tradingEnabled = true;

    function formatTime(t) {
      if (!t) return 'â€“';
      const d = new Date(t);
      return isNaN(d.getTime()) ? t : d.toLocaleString('nl-NL', { dateStyle: 'short', timeStyle: 'medium' });
    }
    function formatAgo(t) {
      if (!t) return 'â€“';
      const d = new Date(t);
      const min = (Date.now() - d.getTime()) / 60000;
      if (min < 1) return 'zojuist';
      if (min < 60) return Math.round(min) + ' min geleden';
      return Math.round(min / 60) + ' u geleden';
    }
    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    async function loadSettings() {
      try {
        const r = await fetch('/api/settings');
        const s = await r.json();
        tradingEnabled = s.tradingEnabled !== false;
        tradingToggle.classList.toggle('on', tradingEnabled);
        tradingToggle.classList.toggle('off', !tradingEnabled);
        tradingStatus.textContent = tradingEnabled ? 'AAN' : 'UIT';
        tradingStatus.classList.toggle('on', tradingEnabled);
        tradingStatus.classList.toggle('off', !tradingEnabled);
      } catch (e) {
        tradingStatus.textContent = 'Kon niet laden';
      }
    }

    async function setTradingEnabled(enabled) {
      try {
        const r = await fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tradingEnabled: enabled }),
        });
        const s = await r.json();
        if (s.error) throw new Error(s.error);
        tradingEnabled = s.tradingEnabled !== false;
        tradingToggle.classList.toggle('on', tradingEnabled);
        tradingToggle.classList.toggle('off', !tradingEnabled);
        tradingStatus.textContent = tradingEnabled ? 'AAN' : 'UIT';
        tradingStatus.classList.toggle('on', tradingEnabled);
        tradingStatus.classList.toggle('off', !tradingEnabled);
      } catch (e) {
        tradingStatus.textContent = 'Fout: ' + e.message;
      }
    }

    tradingToggle.addEventListener('click', () => {
      setTradingEnabled(!tradingEnabled);
    });

    function renderConnections(connections) {
      if (!connections || connections.length === 0) {
        connectionsContainer.innerHTML = '<div class="no-conn">Geen verbindingen. Zet in de EA <strong>UseWebHeartbeat = true</strong> en zorg dat de EA draait.</div>';
        return;
      }
      connectionsContainer.innerHTML = connections.map((c) => {
        const trades = Array.isArray(c.openTrades) ? c.openTrades : [];
        const profitClass = (c.floatingProfit || 0) >= 0 ? 'profit' : 'loss';
        const rows = trades.length
          ? '<table><thead><tr><th>Symbol</th><th>Type</th><th>Volume</th><th>Open</th><th>Huidig</th><th>P/L</th><th>SL</th><th>TP</th></tr></thead><tbody>' +
            trades.map((t) => '<tr><td>' + escapeHtml(t.symbol || '') + '</td><td>' + (t.type === 0 ? 'BUY' : 'SELL') + '</td><td>' + (t.volume ?? '') + '</td><td>' + (t.openPrice ?? '') + '</td><td>' + (t.currentPrice ?? '') + '</td><td class="' + ((t.profit || 0) >= 0 ? 'profit' : 'loss') + '">' + (t.profit ?? '') + '</td><td>' + (t.sl ?? '') + '</td><td>' + (t.tp ?? '') + '</td></tr>').join('') + '</tbody></table>'
          : '<p class="empty">Geen open posities</p>';
        return (
          '<div class="conn-card">' +
          '<div class="conn-head">' +
          '<span class="conn-name">' + escapeHtml(c.hostname || 'VPS') + ' Â· Account ' + escapeHtml(String(c.accountId)) + '</span>' +
          '<span class="conn-meta">Laatst gezien: ' + formatAgo(c.lastSeen) + (c.serverName ? ' Â· ' + escapeHtml(c.serverName) : '') + '</span>' +
          '</div>' +
          '<div class="conn-grid">' +
          '<div class="conn-kv"><span class="k">Balance</span><br><span class="v">' + (c.balance != null ? Number(c.balance).toLocaleString('nl-NL', { minimumFractionDigits: 2 }) : 'â€“') + '</span></div>' +
          '<div class="conn-kv"><span class="k">Equity</span><br><span class="v">' + (c.equity != null ? Number(c.equity).toLocaleString('nl-NL', { minimumFractionDigits: 2 }) : 'â€“') + '</span></div>' +
          '<div class="conn-kv"><span class="k">Margin</span><br><span class="v">' + (c.margin != null ? Number(c.margin).toLocaleString('nl-NL', { minimumFractionDigits: 2 }) : 'â€“') + '</span></div>' +
          '<div class="conn-kv"><span class="k">Vrije marge</span><br><span class="v">' + (c.freeMargin != null ? Number(c.freeMargin).toLocaleString('nl-NL', { minimumFractionDigits: 2 }) : 'â€“') + '</span></div>' +
          '<div class="conn-kv"><span class="k">Open posities</span><br><span class="v">' + (c.openTradesCount ?? 0) + '</span></div>' +
          '<div class="conn-kv"><span class="k">Floating P/L</span><br><span class="v ' + profitClass + '">' + (c.floatingProfit != null ? Number(c.floatingProfit).toLocaleString('nl-NL', { minimumFractionDigits: 2 }) : 'â€“') + '</span></div>' +
          '</div>' +
          '<div class="conn-trades">' + rows + '</div>' +
          '</div>'
        );
      }).join('');
    }

    async function fetchConnections() {
      try {
        const r = await fetch('/api/connections?maxAge=60');
        const data = await r.json();
        renderConnections(data.connections || []);
      } catch (e) {
        connectionsContainer.innerHTML = '<div class="no-conn">Kon verbindingen niet ophalen.</div>';
      }
    }

    function rowClass(entry) {
      const msg = (entry.message || '').toLowerCase();
      if (msg.includes('[vps]') || msg.includes('ok |')) return 'vps';
      if (msg.includes('signaldir=') || msg.includes('confidence=')) return 'signal';
      if (msg.includes('opened ') || msg.includes('trailing stop')) return 'trade';
      return 'level-' + (entry.level || 'info');
    }

    function render(logs) {
      const filtered = levelFilter === 'all' ? logs : logs.filter((e) => (e.level || 'info') === levelFilter);
      if (filtered.length === 0) {
        logList.innerHTML = '<div class="empty">Geen logs (of geen match voor filter).</div>';
        logList.classList.add('empty');
        return;
      }
      logList.classList.remove('empty');
      logList.innerHTML = filtered.map((e) =>
        '<div class="log-line ' + rowClass(e) + '" title="' + escapeHtml((e.message || '').slice(0, 200)) + '">' +
        '<span class="ts">' + formatTime(e.time) + '</span>' +
        (e.symbol ? '<span class="sym">[' + escapeHtml(e.symbol) + ']</span> ' : '') +
        escapeHtml(e.message || '') +
        '</div>'
      ).join('');
      logList.scrollTop = 0;
    }

    const EA_CONNECTED_MINUTES = 10;
    function updateEaStatus(logs) {
      const el = document.getElementById('eaStatus');
      const dot = document.getElementById('dot');
      if (!logs || logs.length === 0) {
        el.textContent = 'EA status: Geen logs. Zet UseWebLog aan in de EA.';
        dot.style.background = 'var(--muted)';
        return;
      }
      const lastTime = logs[0].time;
      const last = lastTime ? new Date(lastTime) : null;
      const minAgo = last ? (Date.now() - last.getTime()) / 60000 : 999;
      if (minAgo <= EA_CONNECTED_MINUTES) {
        el.textContent = 'EA verbonden (laatste log ' + (minAgo < 1 ? 'zojuist' : Math.round(minAgo) + ' min geleden') + ')';
        dot.style.background = 'var(--green)';
      } else {
        el.textContent = 'EA niet recent actief (laatste log ' + (last ? last.toLocaleString('nl-NL') : 'â€“') + ')';
        dot.style.background = 'var(--muted)';
      }
    }

    async function fetchLogs() {
      try {
        const r = await fetch('/api/logs?limit=200');
        const data = await r.json();
        const logs = Array.isArray(data.logs) ? data.logs : [];
        render(logs);
        updateEaStatus(logs);
        statusText.textContent = logs.length > 0 ? 'Laatste update: ' + logs.length + ' logs' : 'Geen logs';
        statusEl.classList.toggle('empty', logs.length === 0);
      } catch (err) {
        statusText.textContent = 'Fout: ' + err.message;
        statusEl.classList.add('empty');
        document.getElementById('eaStatus').textContent = 'Kon logs niet ophalen.';
      }
    }

    document.getElementById('interval').addEventListener('change', (e) => {
      intervalMs = parseInt(e.target.value, 10) * 1000;
      clearInterval(window._logPoll);
      window._logPoll = setInterval(fetchLogs, intervalMs);
    });
    document.getElementById('level').addEventListener('change', (e) => {
      levelFilter = e.target.value;
      fetchLogs();
    });

    document.getElementById('debugTestBtn').addEventListener('click', async () => {
      const resEl = document.getElementById('debugResult');
      resEl.textContent = 'Bezigâ€¦';
      resEl.className = 'debug-result';
      try {
        const r = await fetch('/api/settings');
        const ok = r.ok;
        const data = ok ? await r.json() : null;
        if (ok && data && (data.riskPercent !== undefined || data.tradingEnabled !== undefined)) {
          resEl.textContent = 'API bereikbaar: ja (settings ontvangen)';
          resEl.classList.add('ok');
        } else {
          resEl.textContent = 'API antwoordde met status ' + r.status;
          resEl.classList.add('err');
        }
      } catch (e) {
        resEl.textContent = 'Fout: ' + e.message + ' (CORS of netwerk â€“ controleer of je op api.aitrading.software bent)';
        resEl.classList.add('err');
      }
    });

    loadSettings();
    fetchConnections();
    fetchLogs();
    setInterval(fetchConnections, 15000);
    window._logPoll = setInterval(fetchLogs, intervalMs);
  </script>
</body>
</html>
